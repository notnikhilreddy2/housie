<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Housie - Player</title>
  <style>
    :root {
      --bg: #f8fafc;          /* slate-50 */
      --panel: #ffffff;       /* white */
      --panel-2: #f1f5f9;     /* slate-100 */
      --text: #0f172a;        /* slate-900 */
      --muted: #475569;       /* slate-600 */
      --accent: #16a34a;      /* green-600 */
      --accent-2: #22c55e;    /* green-500 */
      --warn: #dc2626;        /* red-600 */
      --button: #e2e8f0;      /* slate-200 */
      --button-hover: #cbd5e1;/* slate-300 */
      --chip: #e2e8f0;        /* slate-200 */
      --called: #dcfce7;      /* green-100 */
      --called-ring: #16a34a; /* green-600 */
      --last: #bbf7d0;        /* green-200 */
      --border: #e5e7eb;      /* gray-200 */
      --shadow: 0 8px 20px rgba(2, 6, 23, 0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-tap-highlight-color: transparent;
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }

    header {
      position: sticky; top: 0; z-index: 5;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.65));
      backdrop-filter: saturate(1.2) blur(6px);
      border-bottom: 1px solid var(--border);
      margin: 0 -16px 12px; padding: 10px 16px;
      display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 12px;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 32px; height: 32px; border-radius: 8px;
      background: linear-gradient(135deg, #22c55e, #86efac);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    h1 { font-size: 18px; margin: 0; letter-spacing: 0.2px; }

    .btn { background: var(--button); color: var(--text); border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; letter-spacing: 0.2px; transition: background 0.2s ease, transform 0.05s ease; user-select: none; touch-action: manipulation; }
    .btn:hover { background: var(--button-hover); }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: #16a34a; color: white; border-color: #16a34a; }
    .btn-primary:hover { background: #15803d; }
    .btn-danger { background: #ef4444; color: white; border-color: #ef4444; }
    .btn-danger:hover { background: #dc2626; }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }

    .ticket { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); margin: 12px 0; overflow: hidden; }
    .ticket-header { display: flex; justify-content: flex-start; gap: 8px; align-items: center; padding: 12px; background: var(--panel-2); border-bottom: 1px solid var(--border); }
    .ticket-title { font-weight: 800; color: var(--muted); }
    .ticket-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .ticket-body { padding: 12px; display: grid; gap: 12px; }

    /* Grid 3x9 */
    .grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 6px; }
    .cell { position: relative; background: #ffffff; border: 1px solid var(--border); border-radius: 8px; display: grid; place-items: center; height: 46px; font-weight: 800; color: #0f172a; user-select: none; font-size: clamp(14px, 4.2vw, 20px); }
    .cell.blank { background: #f8fafc; border-style: dashed; color: transparent; }
    .cell.number { cursor: pointer; }
    .cell.number.marked { background: var(--called); border-color: #86efac; color: #065f46; box-shadow: inset 0 0 0 2px rgba(34,197,94,0.25); }
    .cell.number:active { transform: scale(0.98); }

    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { background: var(--chip); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 999px; font-weight: 700; }
    .chip.done { background: #dcfce7; border-color: #86efac; color: #064e3b; }

    .empty-state { color: var(--muted); font-size: 14px; padding: 12px; }

    .footer { padding: 10px 2px; color: var(--muted); font-size: 12px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    .kbd { background: #f8fafc; border: 1px solid var(--border); border-bottom-color: #e2e8f0; padding: 2px 6px; border-radius: 6px; font-weight: 700; color: #0f172a; }

    @media (max-width: 720px) {
      .cell { height: 54px; font-size: clamp(16px, 5vw, 22px); }
      .ticket-actions .btn { padding: 10px 12px; }
      h1 { font-size: 17px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Housie – Player</h1>
      </div>
      <div class="toolbar">
        <button id="addTicketBtn" class="btn btn-primary">Add Ticket</button>
      </div>
    </header>

    <div id="tickets"></div>

    <div class="footer">
      <div>
        Tap numbers to mark/unmark. The app checks Early Five, Rows, and Full House.
      </div>
      <div>
        Desktop: Click a cell then use <span class="kbd">Space</span>/<span class="kbd">Enter</span> to toggle.
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'housiePlayerState_v3';

    // --- Crypto-strong PRNG per ticket to ensure unique seeds across players/tickets ---
    function sfc32(a, b, c, d) {
      return function() {
        a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
        var t = (a + b) | 0;
        a = b ^ (b >>> 9);
        b = (c + (c << 3)) | 0;
        c = (c << 21) | (c >>> 11);
        c = (c + t) | 0;
        d = (d + 1) | 0;
        t = (t + d) | 0;
        return (t >>> 0) / 4294967296;
      };
    }

    function newPRNG() {
      let a = 0, b = 0, c = 0, d = 0;
      if (window.crypto && crypto.getRandomValues) {
        const buf = new Uint32Array(4);
        crypto.getRandomValues(buf);
        [a, b, c, d] = buf;
      } else {
        const base = (Date.now() ^ Math.floor(Math.random() * 0xffffffff)) >>> 0;
        a = base;
        b = (base * 1664525 + 1013904223) >>> 0;
        c = (base * 69069 + 362437) >>> 0;
        d = (base * 1103515245 + 12345) >>> 0;
      }
      const seedHex = [a, b, c, d].map(x => x.toString(16).padStart(8, '0')).join('');
      const rand = sfc32(a, b, c, d);
      for (let i = 0; i < 15; i++) rand();
      return { rand, seed: seedHex };
    }

    function rngInt(rand, maxExclusive) { return Math.floor(rand() * maxExclusive); }
    function pick(rand, arr) { return arr[rngInt(rand, arr.length)]; }

    function uid() {
      if (window.crypto && crypto.getRandomValues) {
        const buf = new Uint8Array(16);
        crypto.getRandomValues(buf);
        return 't' + Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
      }
      return 't' + Date.now().toString(36) + Math.floor(Math.random()*1e9).toString(36);
    }

    // Generate a valid 90-ball ticket (3x9, 15 numbers, 5/row, 1-3/col)
    function generateTicketNumbers(rand) {
      const rows = 3, cols = 9;
      for (let attempt = 0; attempt < 200; attempt++) {
        const shape = Array.from({ length: rows }, () => Array(cols).fill(0));
        const rowCounts = [0,0,0];
        const colCounts = Array(cols).fill(0);

        // Ensure at least 1 per column, balanced across rows
        for (let c = 0; c < cols; c++) {
          const minCount = Math.min(...rowCounts);
          const candidates = [0,1,2].filter(r => rowCounts[r] === minCount && rowCounts[r] < 5);
          const r = pick(rand, candidates);
          shape[r][c] = 1; rowCounts[r]++; colCounts[c]++;
        }

        // Add remaining 6 ones (<=3/col, <=5/row), balancing
        let added = 0;
        while (added < 6) {
          const colOptions = [];
          for (let c = 0; c < cols; c++) {
            if (colCounts[c] >= 3) continue;
            const rowsAvail = [0,1,2].filter(r => rowCounts[r] < 5 && shape[r][c] === 0);
            if (rowsAvail.length) colOptions.push({ c, rowsAvail });
          }
          if (!colOptions.length) break;
          const minCol = Math.min(...colOptions.map(o => colCounts[o.c]));
          const colsBalanced = colOptions.filter(o => colCounts[o.c] === minCol);
          const chosenCol = pick(rand, colsBalanced);
          const rMin = Math.min(...chosenCol.rowsAvail.map(r => rowCounts[r]));
          const rowBalanced = chosenCol.rowsAvail.filter(r => rowCounts[r] === rMin);
          const r = pick(rand, rowBalanced);
          shape[r][chosenCol.c] = 1; rowCounts[r]++; colCounts[chosenCol.c]++; added++;
        }

        if (!(rowCounts[0] === 5 && rowCounts[1] === 5 && rowCounts[2] === 5)) continue;

        // Assign numbers per column
        const numbers = Array.from({ length: rows }, () => Array(cols).fill(0));
        let ok = true;
        for (let c = 0; c < cols && ok; c++) {
          const count = colCounts[c];
          const min = (c === 0) ? 1 : c * 10;
          const max = (c === 8) ? 90 : c * 10 + 9;
          const chosen = [];
          const chosenSet = new Set();
          while (chosen.length < count) {
            const val = min + Math.floor(rand() * (max - min + 1));
            if (!chosenSet.has(val)) { chosenSet.add(val); chosen.push(val); }
            if (chosen.length > (max - min + 1)) { ok = false; break; }
          }
          if (!ok) break;
          chosen.sort((a,b) => a - b);
          const rowsWithOne = [];
          for (let r = 0; r < rows; r++) if (shape[r][c] === 1) rowsWithOne.push(r);
          if (rowsWithOne.length !== chosen.length) { ok = false; break; }
          for (let i = 0; i < rowsWithOne.length; i++) {
            numbers[rowsWithOne[i]][c] = chosen[i];
          }
        }
        if (!ok) continue;
        if (!numbers.every(r => r.filter(x => x>0).length === 5)) continue;
        return numbers;
      }
      return Array.from({ length: 3 }, () => Array(9).fill(0));
    }

    function newTicket() {
      const { rand, seed } = newPRNG();
      return {
        id: uid(),
        seed,
        numbers: generateTicketNumbers(rand),
        marks: Array.from({ length: 3 }, () => Array(9).fill(false)),
      };
    }

    const state = { tickets: [] };

    function saveState() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ tickets: state.tickets })); } catch (e) {}
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.tickets)) return false;
        state.tickets = parsed.tickets.filter(t => t && Array.isArray(t.numbers) && Array.isArray(t.marks) && t.id);
        return state.tickets.length > 0;
      } catch (e) { return false; }
    }

    function ticketStats(ticket) {
      const { numbers, marks } = ticket;
      const rows = 3, cols = 9;
      let markedCount = 0, totalNumbers = 0;
      const rowNumberCounts = [0,0,0];
      const rowMarkedCounts = [0,0,0];
      for (let r=0; r<rows; r++) {
        for (let c=0; c<cols; c++) {
          if (numbers[r][c] > 0) {
            totalNumbers++;
            rowNumberCounts[r]++;
            if (marks[r][c]) { markedCount++; rowMarkedCounts[r]++; }
          }
        }
      }
      const earlyFive = markedCount >= 5;
      const row1 = rowMarkedCounts[0] === rowNumberCounts[0];
      const row2 = rowMarkedCounts[1] === rowNumberCounts[1];
      const row3 = rowMarkedCounts[2] === rowNumberCounts[2];
      const fullHouse = markedCount === totalNumbers && totalNumbers === 15;
      return { earlyFive, row1, row2, row3, fullHouse };
    }

    const ticketsEl = document.getElementById('tickets');

    function render() {
      ticketsEl.innerHTML = '';
      if (state.tickets.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'No tickets yet. Tap “Add Ticket” to create one.';
        ticketsEl.appendChild(empty);
      } else {
        for (const ticket of state.tickets) {
          ticketsEl.appendChild(renderTicket(ticket));
        }
      }
      saveState();
    }

    function renderTicket(ticket) {
      const { id, numbers, marks } = ticket;
      const stats = ticketStats(ticket);
      const section = document.createElement('section');
      section.className = 'ticket';
      section.dataset.ticketId = id;

      // Header
      const header = document.createElement('div');
      header.className = 'ticket-header';
      const actions = document.createElement('div');
      actions.className = 'ticket-actions';

      const btnClear = document.createElement('button');
      btnClear.className = 'btn';
      btnClear.textContent = 'Clear Marks';
      btnClear.onclick = () => clearMarks(id);

      const btnRegen = document.createElement('button');
      btnRegen.className = 'btn';
      btnRegen.textContent = 'Regenerate';
      btnRegen.onclick = () => regenTicket(id);

      const btnRemove = document.createElement('button');
      btnRemove.className = 'btn btn-danger';
      btnRemove.textContent = 'Remove';
      btnRemove.onclick = () => removeTicket(id);

      actions.appendChild(btnClear);
      actions.appendChild(btnRegen);
      actions.appendChild(btnRemove);

      header.appendChild(actions);

      // Body
      const body = document.createElement('div');
      body.className = 'ticket-body';

      // Chips (without Corners/Marked)
      const chips = document.createElement('div');
      chips.className = 'chips';
      chips.appendChild(makeChip('Early Five', stats.earlyFive));
      chips.appendChild(makeChip('Top Row', stats.row1));
      chips.appendChild(makeChip('Middle Row', stats.row2));
      chips.appendChild(makeChip('Bottom Row', stats.row3));
      chips.appendChild(makeChip('Full House', stats.fullHouse));

      // Grid
      const grid = document.createElement('div');
      grid.className = 'grid';
      grid.dataset.ticketId = id;
      for (let r=0; r<3; r++) {
        for (let c=0; c<9; c++) {
          const n = numbers[r][c];
          const cell = document.createElement('div');
          if (n === 0) {
            cell.className = 'cell blank';
            cell.setAttribute('aria-hidden', 'true');
            cell.textContent = '#';
          } else {
            cell.className = 'cell number' + (marks[r][c] ? ' marked' : '');
            cell.tabIndex = 0;
            cell.setAttribute('role', 'button');
            cell.setAttribute('aria-pressed', marks[r][c] ? 'true' : 'false');
            cell.dataset.r = r; cell.dataset.c = c; cell.dataset.id = id;
            cell.textContent = n;
          }
          grid.appendChild(cell);
        }
      }

      body.appendChild(chips);
      body.appendChild(grid);

      section.appendChild(header);
      section.appendChild(body);

      return section;
    }

    function clearMarks(id) {
      const t = state.tickets.find(t => t.id === id);
      if (!t) return;
      for (let r=0; r<3; r++) for (let c=0; c<9; c++) t.marks[r][c] = false;
      render();
    }

    function regenTicket(id) {
      const t = state.tickets.find(t => t.id === id);
      if (!t) return;
      const hasMarks = t.marks.some(row => row.some(Boolean));
      if (!hasMarks || confirm('Regenerate this ticket? Marks will be cleared.')) {
        const { rand, seed } = newPRNG();
        t.seed = seed;
        t.numbers = generateTicketNumbers(rand);
        t.marks = Array.from({ length: 3 }, () => Array(9).fill(false));
        render();
      }
    }

    function removeTicket(id) {
      const idx = state.tickets.findIndex(t => t.id === id);
      if (idx === -1) return;
      if (!confirm('Remove this ticket?')) return;
      state.tickets.splice(idx, 1);
      render();
    }

    function shortId(id) { return '#' + id.slice(-4).toUpperCase(); }

    function makeChip(label, done=false) {
      const chip = document.createElement('div');
      chip.className = 'chip' + (done ? ' done' : '');
      chip.textContent = label;
      return chip;
    }

    // Toggle marks (event delegation only for grid cells)
    ticketsEl.addEventListener('click', (e) => {
      const cell = e.target.closest('.cell.number');
      if (cell && cell.dataset && cell.dataset.id) {
        toggleCell(cell.dataset.id, Number(cell.dataset.r), Number(cell.dataset.c));
      }
    });

    ticketsEl.addEventListener('keydown', (e) => {
      if (e.key === ' ' || e.key === 'Enter') {
        const cell = e.target.closest('.cell.number');
        if (cell && cell.dataset && cell.dataset.id) {
          e.preventDefault();
          toggleCell(cell.dataset.id, Number(cell.dataset.r), Number(cell.dataset.c));
        }
      }
    });

    function toggleCell(id, r, c) {
      const t = state.tickets.find(t => t.id === id);
      if (!t) return;
      t.marks[r][c] = !t.marks[r][c];
      render();
    }

    document.getElementById('addTicketBtn').addEventListener('click', () => {
      state.tickets.push(newTicket());
      render();
    });

    // Init
    if (!loadState()) {
      state.tickets.push(newTicket());
    }
    render();
  </script>
</body>
</html>